#+TITLE: Cloud-Native Movie Review Platform
#+AUTHOR: Twilight4

* Table of Contents :toc:
- [[#project-overview][Project Overview]]
  - [[#full-project-directory-structure][Full Project Directory Structure]]
  - [[#full-architecture-diagram][Full Architecture Diagram]]
  - [[#project-scope--technologies-used][Project Scope / Technologies Used]]
  - [[#prerequisites][Prerequisites]]
- [[#deploy-cloud-infrastructure-wip][Deploy Cloud Infrastructure (WIP)]]
  - [[#terraform-resources-overview][Terraform resources overview]]
  - [[#1-authenticate-and-set-up-gcp][1. Authenticate and set up GCP]]
  - [[#2-create-terraform-state-backend][2. Create Terraform State Backend]]
  - [[#3-deploy-the-infrastructure-using-terraform][3. Deploy the infrastructure using terraform]]
  - [[#4-verify-deployment][4. Verify deployment]]
  - [[#5-clean-up][5. Clean up]]
- [[#setup-gitops-argocd-wip][Setup GitOps (ArgoCD) (WIP)]]
- [[#roadmap-wip][Roadmap (WIP)]]

* Project Overview
This project outlines every stage of the DevOps lifecycle, the tools and how the pieces connect. Everything fully automated end-to-end.

This project demonstrates a full production-grade DevOps setup using modern tooling:
- [[#Containerization][Containerization: Docker]]
- [[#Container-Orchestration][Container Orchestration: Kubernetes + Helm]]
- [[#Cloud-Infrastructure][Cloud Technologies (GCP): GKE, GCR, SQL DB]]
- [[#Cloud-Infrastructure][Infrastructure provisioning: Terraform]]
- [[#CICD][CI/CD pipeline: Github Actions]]
- [[#GitOps][GitOps: ArgoCD]]
- [[#Monitoring-and-Logging][Monitoring and Logging: Prometheus, Grafana]]

** Full Project Directory Structure
#+begin_src shell
full-devops-cycle-project/
├── app/                → Application source code + Dockerfile
│   ├── api-node/
│   │   ├── tests/
│   │   │   └── movies.test.js
│   │   ├── src/
│   │   │   ├── db/
│   │   │   ├── routes/
│   │   │   ├── app.js
│   │   │   └── server.js
│   │   ├── Taskfile.yaml
│   │   ├── package.json
│   │   ├── package-lock.json
│   │   └── Dockerfile
│   ├── Taskfile.yaml
│   └── README.md
│
├── k8s/                → Deployment manifests for multi-env setup
│   ├── overlays/
│   │   ├── staging/
│   │   │   ├── movie-api/
│   │   │   │   ├── patches/
│   │   │   │   └── kustomization.yaml
│   │   │   └── kustomization.yaml
│   │   └── production/
│   │       ├── movie-api/
│   │       │   ├── patches/
│   │       │   └── kustomization.yaml
│   │       └── kustomization.yaml
│   ├── helm/
│   │   ├── movie-review-helm-chart/
│   │   │   ├── templates/
│   │   │   ├── values.yaml
│   │   │   ├── values-staging.yaml
│   │   │   └── Chart.yaml
│   │   └── Taskfile.yaml
│   ├── deploy-services/
│   │   ├── movie-api/
│   │   │   ├── namespaces/
│   │   │   ├── manifests/
│   │   │   ├── hostname-staging.yaml
│   │   │   └── hostname-production.yaml
│   │   └── Taskfile.yaml
│   └── Taskfile.yaml
│
├── k8s-cluster-local/      → Docs for Deploying cluster locally
│   ├── kind-bind-mount-2
│   ├── kind-bind-mount-1
│   ├── Taskfile.yaml
│   ├── README.org
│   └── kind-config.yaml.TEMPLATE
│
├── helm/charts/            → Helm chart for deployment
│   └── movie-review/
│       ├── templates/
│       │   ├── movie-api-service.yaml
│       │   ├── movie-api-hpa.yaml
│       │   ├── movie-api-deployment.yaml
│       │   ├── kustomization.yaml
│       │   ├── ingress.yaml
│       │   ├── DATABASE-service.yaml
│       │   ├── secret.yaml
│       │   ├── netpol.yaml
│       │   ├── ingress-nginx-namespace.yaml
│       │   └── configmap.yaml
│       ├── values.yaml
│       ├── values-dev.yaml
│       ├── values-staging.yaml
│       └── Chart.yaml
│
├── terraform/          → Infrastructure as Code (GCP)
│  ├── modules/
│  │   └── gke/
│  │       ├── variables.tf
│  │       ├── outputs.tf
│  │       └── main.tf
│  ├── envs/
│  │   ├── staging/
│  │   │   ├── variables.tf
│  │   │   ├── terraform.tfvars
│  │   │   ├── main.tf
│  │   │   ├── providers.tf
│  │   │   ├── versions.tf
│  │   │   ├── resources.tf
│  │   │   └── backend.tf
│  │   └── production/
│  │       ├── variables.tf
│  │       ├── terraform.tfvars
│  │       ├── main.tf
│  │       ├── providers.tf
│  │       ├── versions.tf
│  │       ├── resources.tf
│  │       └── backend.tf
│  ├── delete-backend.sh
│  └── backend.sh
│
├── monitoring/         → Node + monitoring configuration
│   ├── grafana-dashboards/
│   └── prometheus/
│
├── .github/            → CI/CD pipelines
│   ├── workflows/
│   │   └── ci.yaml
│   └── actions/
│       └── Taskfile.yaml
│
├── Taskfile.yaml
└── README.org
#+end_src

** Full Architecture Diagram
#+begin_src shell
                                    ┌──────────────────────────┐
                                    │        Developers        │
                                    └───────────┬──────────────┘
                                                │ git push
                                                ▼
                                      ┌────────────────────┐
                                      │     GitHub Repo    │
                                      └─────────┬──────────┘
                                                │ triggers
                                                ▼
                                  ┌────────────────────────────────┐
                                  │       GitHub Actions CI/CD     │
                                  └─────────────┬──────────────────┘
                                                │
                                                ▼
                                       ┌──────────────────┐
                                       │ Build Docker Img │
                                       └──────────────────┘
                                                │
                                                ▼ push
                                      ┌──────────────────────┐
                                      │ GCR (Artifact Reg.)  │
                                      └─────────┬────────────┘
                                                │
                                                ▼
                                ┌─────────────────────────────────┐
                                │  GitOps Repo (Helm / Manifests) │
                                └───────────────┬─────────────────┘
                                                │ watched
                                                ▼
                                ┌─────────────────────────────────┐
                                │         ArgoCD (GitOps)         │
                                └───────────────┬─────────────────┘
                                                │ deploys
                                                ▼

                      ┌──────────────────────────────────────────────────────┐
                      │                      GKE Cluster                     │
                      │                                                      │
                      │   ┌────────────┐    ┌─────────────────────────────┐  │
                      │   │ Deployment │--▶│  Horizontal Pod Autoscaler  │  │
                      │   └────────────┘    └─────────────────────────────┘  │
                      │          │                 │                         │
                      │          ▼                 ▼                         │
                      │   ┌────────────┐      ┌──────────────┐               │
                      │   │   Service  │◀──▶│   Ingress    │               │
                      │   └────────────┘      └──────────────┘               │
                      │          │                                           │
                      │          ▼                                           │
                      │   ┌────────────┐                                     │
                      │   │    Pods    │                                     │
                      │   └────────────┘                                     │
                      │                                                      │
                      └─────────────────────────┬────────────────────────────┘
                                                │
                                                │
                                                ▼
                                   ┌───────────────────────────┐
                                   │ Cloud SQL (GCP DB NoSQL)│
                                   └────────────┬──────────────┘
                                                │
                                                │
                                                ▼
                                   ┌──────────────────────────┐
                                   │ Monitoring Stack on GKE  │
                                   │ - Prometheus             │
                                   │ - Grafana                │
                                   └──────────────────────────┘

#+end_src

** Project Scope / Technologies Used
*** Containerization
- Dockerfile
- Image optimization

*** Container Orchestration
- Deployments, Services, Ingress
- ConfigMaps and Secrets
- Horizontal Pod Autoscaler (HPA)
- Namespaces and environment separation
- Network policy
- Liveness/readiness probes
- Kustomize overlays
- Helm chart packaging and templating with namespace/env separation

*** Cloud Infrastructure
Google offers a 90-day, [[https://cloud.google.com/free][$300 free trial]] for new users. 

Terraform provisions GCP infrastructure:
- GKE cluster
- GCS bucket for tfstate backend
- GCP DB NoSQL Database
- VPC, subnets, and firewall rules
- Artifact Registry (GCR)
- IAM roles and service accounts
- Cloud Storage buckets

*** CI/CD
- Build, test pipelines using GitHub Actions
- Docker image building and pushing to GHCR
- Environment-specific deployments (staging, prod)
- Automated application deployment pipeline

*** GitOps
- Automated Kubernetes deployments with ArgoCD
- Declarative Helm charts
- Git-driven versioning and rollbacks

*** Monitoring and Logging
- Prometheus: metrics
- Grafana: dashboards

*** Security
- Kubernetes network policy rules:
  + Allow traffic only from the Ingress Controller
  + Deny ALL other internal pod traffic
  + Allow outbound internet (API needs GCP DB)
- Kubernetes Secret Management
- Terraform IAM least-privilege model

** Prerequisites
- git
- go-task
- docker
- kubectl
- kubectx
- minikube or kind
- helm (v3)
- terraform
- GCP subscription
- google-cloud-cli


* Deploy Cloud Infrastructure (WIP)
** Terraform resources overview
Terraform will create resources in the following sequence:
1. GCP Network
2. subnet
3. firewall rules
4. GKE cluster
5. ...

** 1. Authenticate and set up GCP
#+begin_src shell
# Authenticate to Google Cloud
gcloud auth application-default login

# Create a project
gcloud projects create <PROJECT_NAME>
# Change to another project
gcloud config set project <PROJECT_ID>
# List projects
gcloud projects list

# Set up billing account for your project
## List billing accounts
gcloud billing accounts list
## Check if billing is enabled for a projec
gcloud billing projects describe <PROJECT_ID>
## Link a billing account to a project
gcloud billing projects link <PROJECT_ID> --billing-account=<ACCOUNT_ID>

# Enable the Google Compute Engine API for your project
gcloud services enable compute.googleapis.com
gcloud services enable cloudresourcemanager.googleapis.com

# Set the default region and zone
gcloud config set compute/region <GCP_REGION>
gcloud config set compute/zone <GCP_ZONE>

# Verify configuration
gcloud config configurations list
#+end_src

** 2. Create Terraform State Backend
Terraform needs a remote backend to store its state.

The =backend.sh= script creates the following resources for currently set project:
- GCS bucket with enabled bucket versioning
- dedicated service account with the privileges: storage.admin and viewer
- key for the Terraform backend

The SA and key are created for the purpose of:
- CI/CD automation (Stable, non-expiring credentials)
- Least privilege access
- Auditability
- Stable & central
- Avoid using user credentials in automation (Actions are logged under the SA, not a human user)

#+begin_src shell
# Modify the LOCATION variable and PROJECT_ID to yours and optionally other vars before executing
./backend.sh

# Store the exported terraform-sa-key.json in a secure place in your local machine e.g. ~/.gcp/terraform-sa-key.json
# The set the GOOGLE_APPLICATION_CREDENTIALS environment variable to point to it (for persistence save in shell profile e.g. .zshrc)
export GOOGLE_APPLICATION_CREDENTIALS="$HOME/.gcp/terraform-sa-key.json"

# If you want to clean up the created resources by backend.sh
PROJECT_ID=<my-project> BUCKET_NAME=<tfstate-12345> ./delete-backend.sh

# To view the created resources
gcloud config get-value project                             # Outputs the current project ID set in gcloud
gcloud storage buckets list --project <PROJECT_ID>          # Check if the bucket exists
gcloud iam service-accounts list --project <PROJECT_ID>     # List all service accounts in the project

# NOTE: You don't need to authenticate gcloud using that key
# Terraform will automatically pick up the exported 'GOOGLE_APPLICATION_CREDENTIALS' value
# and execute actions (init, plan, apply) as the SA account
# Authenticate if you want to run gcloud commands as the SA for (debugging or verifying permissions)
gcloud auth activate-service-account --key-file=<KEY_FILE>
# Check which account is active (The * indicates the active account)
gcloud auth list
#+end_src

Then update backend.tf's =bucket= argument to point to the =<BUCKET_NAME>=.

** 3. Deploy the infrastructure using terraform
#+begin_src shell
# Select environment to use
cd terraform/envs/staging

# Initialize terraform for staging env (inside terraform/ directory)
terraform init

# Review the planned configuration
terraform plan -out plan.tfplan

# Apply the terraform configuration
terraform apply plan.tfplan
#+end_src

*** OPTIONAL: Deploy only Kubernetes Cluster Manually
**** Minikube/KinD
If you want to test the cluster locally, visit [[file:/k8s-cluster-local/README.org][k8s-cluster-local/README.org]]

**** Google Kubernetes Engine (GKE)

#+begin_src shell
# View task commands from root directory
go-task --list-all

# Create the GCP network, subnet, firewall rules, and cluster in sequence and connect to the GKE cluster
go-task gcp:01-init-cli          # to run gcloud init for automated setup
go-task gcp:07-create-all
go-task gcp:08-connect-to-cluster

# NOTE: If you have deployed additional resources (such as load balancers) that reference the VPC/Subnets/Etc... 
# you may need to manually clean up those resources in order for 'go-task gcp:09-clean-up' command to succeed. 
# You should also verify that you have cleaned up all resources to avoid unwanted costs.

# To destroy the cluster run
go-task gcp:09-clean-up
#+end_src

** 4. Verify deployment
*** Using GCP Portal
#+begin_src shell

#+end_src

*** Using google-cloud-cli
#+begin_src shell

#+end_src

** 5. Clean up
#+begin_src shell
# Remove all terraform resources and avoid charges
terraform destroy -var-file=dev.tfvars
#+end_src

* Setup GitOps (ArgoCD) (WIP)

* Roadmap (WIP)
Docker application:
- [X] Write demo movie-review app in NodeJS using Express API
- [X] Implement app logic
- [X] Implement API Endpoints (/health, /movies for POST/GET requests)
- [X] Package app with Dockerfile
- [X] Implement image optimization best practices
- [ ] Add GCP DB integration (env vars, CRUD, routes)

CI/CD:
- [X] Generating image tag
- [X] Building and pushing image to GHCR for multi-architecture
- [X] Update staging/production tags for push to main or release tag
- [X] Create Pull Request with image tag changes

Kubernetes:
- [X] Create necessary manifest files (deployment, service, ingress)
- [X] Implement Horizontal Pod Autoscaler for movie-api deployment
- [X] Namespaces and environment separation (Dev → debug mode, Staging → test mode)
  + =namePrefix: dev-= for dev overlay
  + namespace overrides
  + patchesStrategicMerge
  + image overrides
- [X] Implement Kustomize overlays
- [ ] Implement GCP DB integration (ConfigMap, Secret, ExternalName Service)
- [ ] Implement network policy for GCP DB database
- [ ] Implement PersistentVolumeClaims to GCP DB
- [X] Implement helm charts packaging and templating with namespace/env separation
- [ ] After GCP DB creation Success:
  + correct the 3 manifests (GCP -service.yaml, secret.yaml, netpo.yaml) and test
  + add the 3 manifests (GCP -service.yaml, secret.yaml, netpo.yaml) to helm chart
  + implement GCP DB integration to node app

Terraform - replicate in GCP
- [ ] backend config
- [ ] EC2 instances
- [ ] Cloud Storage bucket
- [ ] VPC
  + [ ] Subnet
- [ ] Security groups + rules
- [ ] Application load balancer
  + [ ] ALB target group + attachment
- [ ] Route 53 zone + record
- [ ] RDS instance
- [ ] GKE cluster
- [ ] GCP DB database
- [ ] Artifact Registry (GCR)
- [ ] IAM roles and service accounts

GitOps:
- [ ] Automated Kubernetes deployments with ArgoCD
- [ ] Declarative Helm charts
- [ ] Git-driven versioning and rollbacks 

Grafana, Prometheus:
- [ ] 
