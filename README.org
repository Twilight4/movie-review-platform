#+TITLE: Cloud-Native Movie Review Platform
#+AUTHOR: Twilight4

* Table of Contents :toc:
- [[#overview][Overview]]
  - [[#full-project-directory-structure][Full Project Directory Structure]]
  - [[#full-architecture-diagram][Full Architecture Diagram]]
  - [[#project-scope--technologies-used][Project Scope / Technologies Used]]
- [[#steps-to-deploy-wip][Steps to Deploy (WIP)]]
  - [[#prerequisites][Prerequisites]]
  - [[#1-deploy-cloud-infrastructure][1. Deploy Cloud Infrastructure]]
  - [[#2-deploy-kubernetes-cluster][2. Deploy Kubernetes Cluster]]
  - [[#3-setup-gitops-argocd][3. Setup GitOps (ArgoCD)]]
- [[#roadmap-wip][Roadmap (WIP)]]

* Overview
This project outlines every stage of the DevOps lifecycle, the tools and how the pieces connect. Everything fully automated end-to-end.

This project demonstrates a full production-grade DevOps setup using modern tooling:
- Git / Linux / Networking
- Containerization (Docker)
- Container Orchestration (Kubernetes + Helm)
- Cloud Technologies (GCP - GKE, GCR, CosmosDB)
- Infrastructure provisioning (Terraform)
- CI/CD pipelines (Github Actions)
- GitOps (ArgoCD)
- Monitoring & Logging (Prometheus, Grafana)
- Security

** Full Project Directory Structure
#+begin_src shell
full-devops-cycle-project/
├── app/                → Application source code + Dockerfile
│   ├── tests/
│   │   └── movies.test.js
│   ├── src/
│   │    ├── routes/
│   │    │   └── movies.js
│   │    ├── db/
│   │    │   └── cosmos.js
│   │    ├── server.js
│   │    └── app.js
│   ├── package.json
│   ├── package-lock.json
│   ├── Dockerfile
│   └── README.md
│
├── k8s/                → Deployment manifests
│   ├── overlays
│   │   ├── staging
│   │   │   ├── patch-deployment.yaml
│   │   │   ├── patch-configmap.yaml
│   │   │   └── kustomization.yaml
│   │   └── dev
│   │       ├── patch-deployment.yaml
│   │       ├── patch-configmap.yaml
│   │       └── kustomization.yaml
│   └── base
│       ├── secret.yaml
│       ├── netpol.yaml
│       ├── movie-api-service.yaml
│       ├── movie-api-hpa.yaml
│       ├── movie-api-deployment.yaml
│       ├── kustomization.yaml
│       ├── ingress.yaml
│       ├── ingress-nginx-namespace.yaml
│       ├── cosmos-service.yaml
│       └── configmap.yaml
│
├── helm/charts/               → Helm chart for deployment
│   └── movie-review/
│       ├── templates/
│       │   ├── movie-api-service.yaml
│       │   ├── movie-api-hpa.yaml
│       │   ├── movie-api-deployment.yaml
│       │   ├── kustomization.yaml
│       │   ├── ingress.yaml
│       │   ├── cosmos-service.yaml
│       │   ├── secret.yaml
│       │   ├── netpol.yaml
│       │   ├── ingress-nginx-namespace.yaml
│       │   └── configmap.yaml
│       ├── values.yaml                  # equivelent to base (default)
│       ├── values-dev.yaml              # equivelent to overlays/dev
│       ├── values-staging.yaml          # qeuivelent to overlays/staging
│       └── Chart.yaml
│
├── terraform/          → Infrastructure as Code (GCP)
│
├── monitoring/         → Node + monitoring configuration
│   ├── grafana-dashboards/
│   └── prometheus/
│
├── .github/            → CI/CD pipelines
│   ├── workflows
│   │   └── ci.yaml
│   └── actions
│       └── Taskfile.yaml
│
└── README.org
#+end_src

** Full Architecture Diagram
#+begin_src shell
                                    ┌──────────────────────────┐
                                    │        Developers        │
                                    └───────────┬──────────────┘
                                                │ git push
                                                ▼
                                      ┌────────────────────┐
                                      │     GitHub Repo    │
                                      └─────────┬──────────┘
                                                │ triggers
                                                ▼
                                  ┌────────────────────────────────┐
                                  │       GitHub Actions CI/CD     │
                                  └─────────────┬──────────────────┘
                                                │
                                                ▼
                                       ┌──────────────────┐
                                       │ Build Docker Img │
                                       └──────────────────┘
                                                │
                                                ▼ push
                                      ┌──────────────────────┐
                                      │ GCR (Artifact Reg.)  │
                                      └─────────┬────────────┘
                                                │
                                                ▼
                                ┌─────────────────────────────────┐
                                │  GitOps Repo (Helm / Manifests) │
                                └───────────────┬─────────────────┘
                                                │ watched
                                                ▼
                                ┌─────────────────────────────────┐
                                │         ArgoCD (GitOps)         │
                                └───────────────┬─────────────────┘
                                                │ deploys
                                                ▼

                      ┌──────────────────────────────────────────────────────┐
                      │                      GKE Cluster                     │
                      │                                                      │
                      │   ┌────────────┐    ┌─────────────────────────────┐  │
                      │   │ Deployment │--▶│  Horizontal Pod Autoscaler  │  │
                      │   └────────────┘    └─────────────────────────────┘  │
                      │          │                 │                         │
                      │          ▼                 ▼                         │
                      │   ┌────────────┐      ┌──────────────┐               │
                      │   │   Service  │◀──▶│   Ingress    │               │
                      │   └────────────┘      └──────────────┘               │
                      │          │                                           │
                      │          ▼                                           │
                      │   ┌────────────┐                                     │
                      │   │    Pods    │                                     │
                      │   └────────────┘                                     │
                      │                                                      │
                      └─────────────────────────┬────────────────────────────┘
                                                │
                                                │
                                                ▼
                                   ┌───────────────────────────┐
                                   │ Cloud SQL (CosmosDB NoSQL)│
                                   └────────────┬──────────────┘
                                                │
                                                │
                                                ▼
                                   ┌──────────────────────────┐
                                   │ Monitoring Stack on GKE  │
                                   │ - Prometheus             │
                                   │ - Grafana                │
                                   └──────────────────────────┘

#+end_src

** Project Scope / Technologies Used
*** Containerization
- Dockerfile
- Image optimization

*** Kubernetes
- Deployments, Services, Ingress
- ConfigMaps and Secrets
- Horizontal Pod Autoscaler (HPA)
- Namespaces and environment separation
- Network policy
- Liveness/readiness probes
- Kustomize overlays
- Helm chart packaging and templating with namespace/env separation

*** Cloud Infrastructure
Using Terraform to provision GCP infrastructure:
- GKE cluster
- Cloud CosmosDB NoSQL Database
- VPC, subnets, and firewall rules
- Artifact Registry (GCR)
- IAM roles and service accounts
- Cloud Storage buckets

*** CI/CD
- Build, test, lint pipelines using GitHub Actions
- Docker image building and pushing to GCR
- Automated application deployment pipeline
- Environment-specific deployments (dev, staging, prod)

*** GitOps
- Automated Kubernetes deployments with ArgoCD
- Declarative Helm charts
- Git-driven versioning and rollbacks

*** Monitoring and Logging
- Prometheus: metrics
- Grafana: dashboards

*** Security
- Kubernetes network policy rules:
  + Allow traffic only from the Ingress Controller
  + Deny ALL other internal pod traffic
  + Allow outbound internet (API needs Cosmos DB)
- Kubernetes Secret Management
- Terraform IAM least-privilege model

* Steps to Deploy (WIP)
** Prerequisites
- git
- docker
- kubectl
- minikube or kind
- helm (v3)
- terraform
- Azure subscription (Owner or Contributor role)
- azure-cli

** 1. Deploy Cloud Infrastructure
*** Authenticate with Azure
*** Deploy the infrastructure
#+begin_src shell
# Change directory
cd terraform/

# Initialize terraform
terraform init

# Review the planned configuration
terraform plan -out plan.tfplan

# Apply the terraform configuration
terraform apply plan.tfplan
#+end_src

*** Verify deployment
**** Using Azure Portal
**** Using Azure CLI

*** Clean up
#+begin_src shell
# Remove all terraform resources and avoid charges
terraform destroy -var-file=dev.tfvars
#+end_src

** 2. Deploy Kubernetes Cluster
*** Test Locally
**** Minikube via kubectl
#+begin_src shell
# Start cluster and enable ingress add-on
minikube start
minikube addons enable ingress

# Apply default env (namespace env equivelent to k8s/base)
kubectl apply -k k8s/base

# Apply kustomize for dev
kubectl create namespace dev            # kustomize expects existing 'dev' namespace
kubectl apply -k k8s/overlays/dev

# Apply kustomize for staging env
kubectl create namespace dev            # kustomize expects existing staging' namespace
kubectl apply -k k8s/overlays/dev

# Uninstall overlay manifest for dev env
kubectl delete -k k8s/overlays/dev
# OR just delete created entire namespaces
kubectl delete namespace dev
kubectl delete namespace ingress-nginx
#+end_src

**** Minikube via helm
#+begin_src shell
# Install - default env (namespace env equivelent to k8s/base)
helm install movie-review-chart helm/charts/movie-review

# Upgrade - dev env
helm upgrade --install movie-review-chart helm/charts/movie-review -f values-dev.yaml --namespace dev

# Upgrade - staging env
helm upgrade --install movie-review-chart helm/charts/movie-review -f values-staging.yaml --namespace staging

# Uninstall
helm uninstall movie-review-chart
#+end_src

**** Test health endpoint
#+begin_src shell
# Port-forward the service
kubectl port-forward pod/<POD_NAME> 3000:80 
xh localhost:3000/health

# OR check from inside of the container
kubectl exec -it <POD_NAME> -- netstat -tlnp           # to check which port the service is running on
kubectl exec -it <POD_NAME> -- wget -qO- http://localhost:3000/health

# Expected output: {"status":"ok"}
#+end_src

*** Azure Cloud

** 3. Setup GitOps (ArgoCD)


* Roadmap (WIP)
Docker application:
- [X] Write demo movie-review app in NodeJS using Express API
- [X] Implement app logic
- [X] Implement API Endpoints (/health, /movies for POST/GET requests)
- [X] Package app with Dockerfile
- [X] Implement image optimization best practices
- [ ] Add Azure CosmosDB integration (env vars, CRUD, routes)

CI/CD:
- [X] Generating image tag
- [X] Building and pushing image to GHCR for multi-architecture
- [ ] Update staging/production tags for push to main or release tag
- [ ] Create Pull Request with image tag changes

Kubernetes:
- [X] Create necessary manifest files (deployment, service, ingress)
- [X] Implement Horizontal Pod Autoscaler for movie-api deployment
- [X] Namespaces and environment separation (Dev → debug mode, Staging → test mode)
  + =namePrefix: dev-= for dev overlay
  + namespace overrides
  + patchesStrategicMerge
  + image overrides
- [X] Implement Kustomize overlays
- [ ] Implement CosmosDB integration for Azure (ConfigMap, Secret, CosmosDB ExternalName Service)
- [ ] Implement network policy for CosmosDB database
- [ ] Implement PersistentVolumeClaims to CosmosDB
- [ ] Implement helm charts packaging and templating with namespace/env separation
- [ ] After CosmosDB creation Success:
  + correct the 3 manifests (cosmos-service.yaml, secret.yaml, netpo.yaml) and test
  + add the 3 manifests (cosmos-service.yaml, secret.yaml, netpo.yaml) to helm chart
  + implement cosmosDB integration to node app

Terraform:
- [ ] GKE cluster
- [ ] CosmosDB database
- [ ] VPC, subnets, and firewall rules
- [ ] Artifact Registry (GCR)
- [ ] IAM roles and service accounts
- [ ] Cloud Storage buckets

GitOps:
- [ ] Automated Kubernetes deployments with ArgoCD
- [ ] Declarative Helm charts
- [ ] Git-driven versioning and rollbacks 

Grafana, Prometheus:
- [ ] 
